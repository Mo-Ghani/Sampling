


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.0">
    
    
      
        <title>Gamma-Ray Spectroscopy with PyMC3 and dynesty - Demonstrations of MCMC and Nested Samplers in Physics</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.b5d04df8.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-pymc3-and-dynesty-to-fit-gaussian-curves-to-photopeaks-in-a-gamma-ray-spectrum" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Demonstrations of MCMC and Nested Samplers in Physics" class="md-header-nav__button md-logo" aria-label="Demonstrations of MCMC and Nested Samplers in Physics">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Demonstrations of MCMC and Nested Samplers in Physics
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Gamma-Ray Spectroscopy with PyMC3 and dynesty
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Demonstrations of MCMC and Nested Samplers in Physics" class="md-nav__button md-logo" aria-label="Demonstrations of MCMC and Nested Samplers in Physics">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Demonstrations of MCMC and Nested Samplers in Physics
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Gamma-Ray Spectroscopy with PyMC3 and dynesty
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Gamma-Ray Spectroscopy with PyMC3 and dynesty" class="md-nav__link md-nav__link--active">
      Gamma-Ray Spectroscopy with PyMC3 and dynesty
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#useful-imports" class="md-nav__link">
    Useful imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#viewing-the-data" class="md-nav__link">
    Viewing the data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-model" class="md-nav__link">
    The model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-with-pymc3" class="md-nav__link">
    Modelling with PyMC3
  </a>
  
    <nav class="md-nav" aria-label="Modelling with PyMC3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sampling-the-data" class="md-nav__link">
    Sampling the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sampling-the-data-alternate-method" class="md-nav__link">
    Sampling the data - Alternate method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    Results
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-the-posterior" class="md-nav__link">
    Plotting the posterior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-comparisons" class="md-nav__link">
    Model comparisons
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-with-dynesty" class="md-nav__link">
    Modelling with dynesty
  </a>
  
    <nav class="md-nav" aria-label="Modelling with dynesty">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sampling-the-data_1" class="md-nav__link">
    Sampling the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results_1" class="md-nav__link">
    Results
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-the-posterior_1" class="md-nav__link">
    Plotting the posterior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-comparisons_1" class="md-nav__link">
    Model comparisons
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../LightCurve/LightCurve/" title="Exoplanet Light Curve Analysis with emcee and UltraNest" class="md-nav__link">
      Exoplanet Light Curve Analysis with emcee and UltraNest
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../Sunspots2/Sunspots2/" title="Solar Cycle Analysis with Zeus and Nestle" class="md-nav__link">
      Solar Cycle Analysis with Zeus and Nestle
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../gravwaves/gravwaves/" title="Gravitational Wave Parameter Estimation with bilby" class="md-nav__link">
      Gravitational Wave Parameter Estimation with bilby
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../particleID/particleID/" title="Particle Identification in Proton-Proton Collisions with PyStan" class="md-nav__link">
      Particle Identification in Proton-Proton Collisions with PyStan
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../TheOnlineMCMC/TheOnlineMCMC/" title="Zero Installation Sampling with The Online MCMC" class="md-nav__link">
      Zero Installation Sampling with The Online MCMC
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#useful-imports" class="md-nav__link">
    Useful imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#viewing-the-data" class="md-nav__link">
    Viewing the data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-model" class="md-nav__link">
    The model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-with-pymc3" class="md-nav__link">
    Modelling with PyMC3
  </a>
  
    <nav class="md-nav" aria-label="Modelling with PyMC3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sampling-the-data" class="md-nav__link">
    Sampling the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sampling-the-data-alternate-method" class="md-nav__link">
    Sampling the data - Alternate method
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    Results
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-the-posterior" class="md-nav__link">
    Plotting the posterior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-comparisons" class="md-nav__link">
    Model comparisons
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling-with-dynesty" class="md-nav__link">
    Modelling with dynesty
  </a>
  
    <nav class="md-nav" aria-label="Modelling with dynesty">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sampling-the-data_1" class="md-nav__link">
    Sampling the data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#results_1" class="md-nav__link">
    Results
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-the-posterior_1" class="md-nav__link">
    Plotting the posterior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-comparisons_1" class="md-nav__link">
    Model comparisons
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="using-pymc3-and-dynesty-to-fit-gaussian-curves-to-photopeaks-in-a-gamma-ray-spectrum">Using PyMC3 and dynesty to fit Gaussian curves to photopeaks in a gamma-ray spectrum</h1>
<p>A gamma-ray spectrum (GRS) is a histogram describing the counts of detected photons as a function of photon energy. GRS can be useful when evaluating the dosage received from a sample containing unknown radioisotopes. To do this, the total counts produced above background by a source has to be calculated. </p>
<p>Above the background level, a gamma source produces sharp peaks, called "photopeaks", due to discrete energy level changes in a nucleus. A method for finding the total counts is to fit a curve to every photopeak in a GRS, and integrate each one to find the total area contained under photopeaks.</p>
<p>In this example, I'll use MCMC to fit Gaussian curves to peaks found in gamma-ray spectrum of a sample of Ba-133.</p>
<h2 id="useful-imports">Useful imports</h2>
<div class="codehilite"><pre><span></span><code><span class="c1"># numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># scipy</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">ndtri</span><span class="p">,</span> <span class="n">gammaln</span>

<span class="c1"># Plotting</span>
<span class="kn">import</span> <span class="nn">corner</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="c1"># Samplers</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PyMC3 version: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">dynesty</span>
<span class="kn">from</span> <span class="nn">dynesty</span> <span class="kn">import</span> <span class="n">NestedSampler</span>
<span class="kn">from</span> <span class="nn">dynesty.utils</span> <span class="kn">import</span> <span class="n">resample_equal</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dynesty version: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dynesty</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>

<span class="c1"># misc</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>PyMC3 version: 3.8
dynesty version: 1.0.1
</code></pre></div>

<h2 id="viewing-the-data">Viewing the data</h2>
<p>The data is in the form of a histogram with over 16000 bins, each with width of one <a href="https://en.wikipedia.org/wiki/Multichannel_analyzer">"MCA-Channel"</a>. This unit of energy is specific to the detector used to collect the GRS, and so we also must calibrate the spectrum to have a bin width in keV.</p>
<p>Start by loading in both the calibration parameters, and the entire gamma-ray spectrum as a list:</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#Load detector calibration</span>
<span class="n">cali_dir</span> <span class="o">=</span> <span class="s1">&#39;calibration.txt&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cali_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">calibration</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
<span class="n">calibration</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">calibration</span><span class="p">))</span>
<span class="n">c_0</span> <span class="o">=</span> <span class="n">calibration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">c_2</span> <span class="o">=</span> <span class="n">calibration</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="c1">#Load gamma-ray spectrum data</span>
<span class="n">spectra_dir</span> <span class="o">=</span> <span class="s1">&#39;Ba.TKA&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">spectra_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">file</span><span class="p">]</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
</code></pre></div>


<p>The spectrum contains an X-ray region at lower energies, and an extremely noisy region at higher energies. Both of these regions are not very useful for this demonstration, so I'll only show the section I'll be searching for photopeaks.</p>
<div class="codehilite"><pre><span></span><code><span class="n">xrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span>  <span class="c1"># Bins for gamma-ray spectrum</span>

<span class="c1"># Plot the spectrum</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xrange</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Energy / MCA Channels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gamma-Ray Spectrum of a sample of Ba-133&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mi">3500</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


<p><img alt="png" src="../output_8_0.png" /></p>
<p>The spectrum is made up of a smooth background counts curve, with sharp peaks sitting on top. These are the photopeaks we're searching for.
Using scipy's "find_peaks" function, we can select some photopeaks in the spectrum to analyse. This function looks for local maxima by comparing a point to it's neighbours. The optional arguments specify the minimum height for a peak to be returned, and a "neighbourhood width", so only the largest peak in a given neighbourhood will be returned. </p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Find prominent peaks in data using scipy</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1300</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">100</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">:]</span>
</code></pre></div>


<p>This function returns the indicies at which a peak maximum is located in the gamma-ray spectrum. Next, I'll define a "radius" of 20 bins around each peak centre, and create lists containing the data for each peak. </p>
<p>Let's plot each peak to see what the function found:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># select an area around peak to be plotted &amp; calibrate energy scale to keV </span>
<span class="n">ranger</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">peaks_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">c_0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">peak</span><span class="o">-</span><span class="n">ranger</span><span class="p">,</span> <span class="n">peak</span><span class="o">+</span><span class="n">ranger</span><span class="p">))</span> <span class="o">+</span> <span class="n">c_2</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>
<span class="n">peaks_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">counts</span><span class="p">[</span><span class="n">peak</span><span class="o">-</span><span class="n">ranger</span><span class="p">:</span><span class="n">peak</span><span class="o">+</span><span class="n">ranger</span><span class="p">]</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>

<span class="c1"># Plot selected peaks from gamma-ray spectrum</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peaks_x</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">peaks_y</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">peaks_x</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">peaks_y</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy / KeV&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Photopeaks produced by a sample of Ba-133&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


<p><img alt="png" src="../output_12_0.png" /></p>
<h2 id="the-model">The model</h2>
<p>The decays that cause the photopeaks in a GRS have a discrete energy. The width of the photopeaks is caused by imperfections in the detector crystal, such as defects or excess thermal energy. This causes each peak to have a <a href="https://en.wikipedia.org/wiki/Gaussian_function">Gaussian nature</a>, rather than a sharp peak.</p>
<p>I'll attempt to fit a Gaussian curve to each peak, by first defining the Gaussian fuction to be used:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">y0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gaussian function</span>
<span class="sd">    :param x: 1D array of input points</span>
<span class="sd">    :param a: Amplitude of peak</span>
<span class="sd">    :param xc: Mean peak energy</span>
<span class="sd">    :param w: Standard deviation of peak</span>
<span class="sd">    :param y0: Background counts under peak</span>
<span class="sd">    :return: 1D array of Gaussian output points</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">y0</span>
</code></pre></div>


<h2 id="modelling-with-pymc3">Modelling with PyMC3</h2>
<p>Our goal is to find the values of the parameters above that best explain each photopeak. To ensure that the algorithms quickly converge on the most likely parameter values, I'll guess some values for the parameters of each peak, simply by using the plots above. Since the standard deviation appears roughly the same for all the peaks, I'll set the prior to be uniform.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#initialise a model for each peak, and define guesses for the parameters</span>
<span class="n">gauss_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">))]</span>
<span class="n">a_guesses</span> <span class="o">=</span> <span class="p">[</span><span class="mf">23000.</span><span class="p">,</span> <span class="mf">900.</span><span class="p">,</span> <span class="mf">6100.</span><span class="p">,</span> <span class="mf">13800.</span><span class="p">,</span> <span class="mf">39800.</span><span class="p">,</span> <span class="mf">5300.</span><span class="p">]</span>
<span class="n">xc_guesses</span> <span class="o">=</span> <span class="p">[</span><span class="mf">81.</span><span class="p">,</span> <span class="mf">161.</span><span class="p">,</span> <span class="mf">276.5</span><span class="p">,</span> <span class="mf">303.</span><span class="p">,</span> <span class="mf">356.</span><span class="p">,</span> <span class="mf">384.</span><span class="p">]</span>
<span class="n">y0_guesses</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1700.</span><span class="p">,</span> <span class="mf">1350.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">,</span> <span class="mf">250.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">]</span>
</code></pre></div>


<h3 id="sampling-the-data">Sampling the data</h3>
<p>Next, I'll use the above guesses to initialise each model. PyMC3 requires the user to provide a prior for each parameter, and a likelihood function, which can be easily set using the PyMC3 in-built Normal, Uniform, and Poisson probabillity distribution functions. </p>
<p>I'll be using a <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson</a> likelihood, since Poisson distributions show how many times an event is likely to occur in a certain time period, assuming that events are independant and occur at a constant rate. Since radioactive decays are independant, and the half-life of Ba-133 is around 10.5 years, this makes a Poisson distribution <a href="https://en.wikipedia.org/wiki/Photon_statistics">suited for photon counting.</a></p>
<p>This is done within the scope of each model defined above, using the "with" statement:</p>
<div class="codehilite"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">gauss_models</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="c1"># set prior parameters</span>
        <span class="c1"># amplitude</span>
        <span class="n">a_mu</span> <span class="o">=</span> <span class="n">a_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># mean of amplitude of peaks</span>
        <span class="n">a_sig</span> <span class="o">=</span> <span class="mf">100.</span>            <span class="c1"># standard deviation of amplitude of peaks</span>

        <span class="c1"># peak energy</span>
        <span class="n">xc_mu</span> <span class="o">=</span> <span class="n">xc_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># mean of peak energy</span>
        <span class="n">xc_sig</span> <span class="o">=</span> <span class="mf">1.</span>            <span class="c1"># standard deviation of peak energy</span>

        <span class="c1"># standard deviation</span>
        <span class="n">w_min</span> <span class="o">=</span> <span class="mf">0.3</span>             <span class="c1"># lower bound of peak standard deviation</span>
        <span class="n">w_max</span> <span class="o">=</span> <span class="mf">2.5</span>             <span class="c1"># upper bound of peak standard deviation</span>

        <span class="c1"># background counts</span>
        <span class="n">y0_mu</span> <span class="o">=</span> <span class="n">y0_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># mean of background counts</span>
        <span class="n">y0_sig</span> <span class="o">=</span> <span class="mf">30.</span>           <span class="c1"># standard deviation of background counts</span>

        <span class="c1"># set normal priors</span>
        <span class="n">a_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">a_sig</span><span class="p">)</span> 
        <span class="n">xc_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Peak Energy&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">xc_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">xc_sig</span><span class="p">)</span>  
        <span class="n">w_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;Standard Deviation&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">w_min</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">w_max</span><span class="p">)</span>  
        <span class="n">y0_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Background Counts&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">y0_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">y0_sig</span><span class="p">)</span>

        <span class="c1"># Expected value of outcome</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">peaks_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a_model</span><span class="p">,</span> <span class="n">xc_model</span><span class="p">,</span> <span class="n">w_model</span><span class="p">,</span> <span class="n">y0_model</span><span class="p">)</span>

        <span class="c1"># Poisson likelihood of observations</span>
        <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;Y_obs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">peaks_y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></div>


<p>Now each model has been initialised, the MCMC sampling algorithm can now be applied. PyMC3 uses a set of samples, as well as a set of tuning samples. We can also use the "time" package to record how long it took to sample all of the photopeaks.</p>
<div class="codehilite"><pre><span></span><code><span class="n">Nsamples</span> <span class="o">=</span> <span class="mi">800</span>   <span class="c1"># number of samples</span>
<span class="n">Ntune</span> <span class="o">=</span> <span class="mi">1000</span>     <span class="c1"># number of tuning samples</span>

<span class="c1"># disable PyMC3 console logs, for neatness</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pymc3&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="c1"># perform sampling</span>
<span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">gauss_models</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">Nsamples</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="n">Ntune</span><span class="p">,</span> <span class="n">discard_tuned_samples</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

<span class="n">timepymc3</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span>  <span class="c1"># time taken to sample all of the photopeaks</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> seconds (</span><span class="si">{}</span><span class="s1"> seconds per peak) taken to run PyMC3 sampling.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timepymc3</span><span class="p">,</span> <span class="n">timepymc3</span><span class="o">/</span><span class="mi">6</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Sampling 4 chains, 0 divergences: 100%|██████████| 7200/7200 [00:10&lt;00:00, 699.00draws/s] 
Sampling 4 chains, 0 divergences: 100%|██████████| 7200/7200 [00:09&lt;00:00, 757.94draws/s] 
Sampling 4 chains, 0 divergences: 100%|██████████| 7200/7200 [00:10&lt;00:00, 715.65draws/s] 
Sampling 4 chains, 0 divergences: 100%|██████████| 7200/7200 [00:10&lt;00:00, 674.49draws/s] 
Sampling 4 chains, 0 divergences: 100%|██████████| 7200/7200 [00:10&lt;00:00, 661.42draws/s] 
Sampling 4 chains, 0 divergences: 100%|██████████| 7200/7200 [00:10&lt;00:00, 710.30draws/s]


276.74090600013733 seconds (46.123484333356224 seconds per peak) taken to run PyMC3 sampling.
</code></pre></div>

<h3 id="sampling-the-data-alternate-method">Sampling the data - Alternate method</h3>
<p>The above method uses a Poisson likelihood, since a metric like counts is non-negative. Although, since the peaks in the gamma-ray spectrum have large enough amplitudes, the likelihood can be well approximated by a normal distribution, with a estimate for the noise standard deviation. Guessing this standard deviation value is tricky, so instead we can set it as an extra parameter for the sampler. A good prior to start with is a uniform probabillity distribution in log-space, meaning the standard deviation has an equal probabillity of having any order of magnitude between an upper and lower bound.</p>
<p>I'll showcase this method, but I'll use the previous method for the results section below. I'll also use only the 2nd peak found, as it has the noisiest data and will likely produce the most interesting results. Start by initiating a new set of models using simillar code as before, but with the new likelihood.</p>
<div class="codehilite"><pre><span></span><code><span class="n">gauss_model_alt</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
<span class="k">with</span> <span class="n">gauss_model_alt</span><span class="p">:</span>
    <span class="c1"># set prior parameters</span>
    <span class="c1"># amplitude</span>
    <span class="n">a_mu</span> <span class="o">=</span> <span class="n">a_guesses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="c1"># mean of amplitude of peaks</span>
    <span class="n">a_sig</span> <span class="o">=</span> <span class="mf">50.</span>            <span class="c1"># standard deviation of amplitude of peaks</span>

    <span class="c1"># peak energy</span>
    <span class="n">xc_mu</span> <span class="o">=</span> <span class="n">xc_guesses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># mean of peak energy</span>
    <span class="n">xc_sig</span> <span class="o">=</span> <span class="mf">1.</span>            <span class="c1"># standard deviation of peak energy</span>

    <span class="c1"># standard deviation</span>
    <span class="n">w_mu</span> <span class="o">=</span> <span class="mf">1.2</span>             <span class="c1"># mean of peak standard deviation</span>
    <span class="n">w_sig</span> <span class="o">=</span> <span class="mf">1.</span>             <span class="c1"># standard deviation of peak standard deviation</span>

    <span class="c1"># background counts</span>
    <span class="n">y0_mu</span> <span class="o">=</span> <span class="n">y0_guesses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># mean of background counts</span>
    <span class="n">y0_sig</span> <span class="o">=</span> <span class="mf">30.</span>           <span class="c1"># standard deviation of background counts</span>

    <span class="c1"># noise deviation</span>
    <span class="n">sigma_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>         <span class="c1"># minimum order of magnitude of the noise deviation</span>
    <span class="n">sigma_max</span> <span class="o">=</span> <span class="mi">2</span>          <span class="c1"># maximum order of magnitude of the noise deviation</span>

    <span class="c1"># set normal priors</span>
    <span class="n">a_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">a_sig</span><span class="p">)</span>
    <span class="n">xc_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Peak Energy&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">xc_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">xc_sig</span><span class="p">)</span>
    <span class="n">w_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Standard Deviation&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">w_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">w_sig</span><span class="p">)</span>
    <span class="n">y0_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Background Counts&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">y0_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">y0_sig</span><span class="p">)</span>
    <span class="c1"># set uniform prior</span>
    <span class="n">sigma_model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="s1">&#39;Noise&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="n">sigma_min</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">sigma_max</span><span class="p">)</span>

    <span class="c1"># Expected value of outcome</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">(</span><span class="n">peaks_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a_model</span><span class="p">,</span> <span class="n">xc_model</span><span class="p">,</span> <span class="n">w_model</span><span class="p">,</span> <span class="n">y0_model</span><span class="p">)</span>
    <span class="c1"># Normal likelihood of observations with noise</span>
    <span class="n">Y_obs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;Y_obs&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">10</span> <span class="o">**</span> <span class="n">sigma_model</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">peaks_y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>


<p>Performing the sampling again gives our alternate posteriors:</p>
<div class="codehilite"><pre><span></span><code><span class="n">Nsamples</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">Ntune</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># perform sampling</span>
<span class="n">t0_alt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="k">with</span> <span class="n">gauss_model_alt</span><span class="p">:</span>
    <span class="n">trace_alt</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">Nsamples</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="n">Ntune</span><span class="p">,</span> <span class="n">discard_tuned_samples</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t1_alt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

<span class="n">timepymc3_alt</span> <span class="o">=</span> <span class="n">t1_alt</span><span class="o">-</span><span class="n">t0_alt</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> seconds taken to run PyMC3 alternate sampling.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timepymc3_alt</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Sampling 4 chains, 0 divergences: 100%|██████████| 7200/7200 [00:09&lt;00:00, 727.73draws/s]


43.72043991088867 seconds taken to run PyMC3 alternate sampling.
</code></pre></div>

<p>We can now briefly use the trace to see what values the sampler converged on for each parameter. I'll return to these values later when finding the uncertainty of the counts under the photopeak.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># collect samples of each parameter</span>
<span class="n">samples_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">trace_alt</span><span class="p">[</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">],</span>
                         <span class="n">trace_alt</span><span class="p">[</span><span class="s1">&#39;Peak Energy&#39;</span><span class="p">],</span>
                         <span class="n">trace_alt</span><span class="p">[</span><span class="s1">&#39;Standard Deviation&#39;</span><span class="p">],</span>
                         <span class="n">trace_alt</span><span class="p">[</span><span class="s1">&#39;Background Counts&#39;</span><span class="p">],</span>
                         <span class="n">trace_alt</span><span class="p">[</span><span class="s1">&#39;Noise&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># mean and standard deviation error of each parameter</span>
<span class="n">a_alt</span><span class="p">,</span> <span class="n">a_err_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">xc_alt</span><span class="p">,</span> <span class="n">xc_err_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">w_alt</span><span class="p">,</span> <span class="n">w_err_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">y0_alt</span><span class="p">,</span> <span class="n">y0_err_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">sigma_alt</span><span class="p">,</span> <span class="n">sigma_err_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">[:,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">a_w_alt_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">samples_alt</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

<span class="c1"># print values</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameter mean values with uncertainties for a photopeak in a sample of Ba-133: </span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;            Amplitude = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_alt</span><span class="p">,</span> <span class="n">a_err_alt</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;           Peak Energy = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> keV </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xc_alt</span><span class="p">,</span> <span class="n">xc_err_alt</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;    Standard Deviation = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> keV </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w_alt</span><span class="p">,</span> <span class="n">w_err_alt</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;     Background Counts = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y0_alt</span><span class="p">,</span> <span class="n">y0_err_alt</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;                 Noise = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma_alt</span><span class="p">,</span> <span class="n">sigma_err_alt</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Parameter mean values with uncertainties for a photopeak in a sample of Ba-133:

             Amplitude = 805.5161312481847 ± 22.51101688252669 counts 
           Peak Energy = 160.6059216398261 ± 0.018834853387709613 keV 
    Standard Deviation = 0.5233786079419919 ± 0.019371192247871535 keV 
     Background Counts = 1333.599554840382 ± 7.251969008469188 counts 
                 Noise = 1.5885697487281636 ± 0.05223363708405703 counts
</code></pre></div>

<h3 id="results">Results</h3>
<p>Now that the data has been sampled, we can collect the information for each parameter posterior using the traces. By using a dictionary, we can also collect the mean and standard deviation for each parameter, which will be useful later for plotting the fitted curves.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># collect traces of each parameter from each peak</span>
<span class="n">all_pymc3_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">],</span>
                                <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;Peak Energy&#39;</span><span class="p">],</span>
                                <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;Standard Deviation&#39;</span><span class="p">],</span>
                                <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;Background Counts&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">]</span>

<span class="c1"># dictionaries to contain mean and standard deviation of each peak</span>
<span class="n">resdict</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">))]</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;a_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;a_sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;xc_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;xc_sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;w_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;w_sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;y0_mu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;y0_sig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">])</span>
</code></pre></div>


<p>To visualise the information given for each parameter, we can define a function to plot the parameter posteriors, and also create contour plots that describe how any two parameters might depend on each other. This is done using "corner.py". </p>
<p>As an example, I'll use the 2nd peak again due to its noisy data: </p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">plotposts</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to plot posteriors using corner.py and scipy&#39;s gaussian KDE function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hist_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="c1"># plot KDE smoothed version of distributions</span>
    <span class="k">for</span> <span class="n">axidx</span><span class="p">,</span> <span class="n">samps</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span> <span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">samps</span><span class="p">)</span>
        <span class="n">xvals</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axidx</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axidx</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">kde</span><span class="p">(</span><span class="n">xvals</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;firebrick&quot;</span><span class="p">)</span>

<span class="c1"># create corner plot for peak with noisiest data </span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;Amplitude&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Peak Energy&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Standard Deviation&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;Background Counts&#39;</span><span class="p">]</span>
<span class="n">corner_plot_samples</span> <span class="o">=</span> <span class="n">all_pymc3_samples</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">plotposts</span><span class="p">(</span><span class="n">corner_plot_samples</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</code></pre></div>


<p><img alt="png" src="../output_35_0.png" /></p>
<p>This corner plot shows that the amplitude of a photopeak and its standard deviation are dependant, since their contour plot is not symmetric.</p>
<p>Now that we have the parameter posteriors, along with their means and standard deviations, we can state the most likely value of each parameter, with their uncertainties:</p>
<div class="codehilite"><pre><span></span><code><span class="n">a</span><span class="p">,</span> <span class="n">a_err</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;a_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;a_sig&#39;</span><span class="p">]</span>
<span class="n">xc</span><span class="p">,</span> <span class="n">xc_err</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;xc_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;xc_sig&#39;</span><span class="p">]</span>
<span class="n">w</span><span class="p">,</span> <span class="n">w_err</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;w_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;w_sig&#39;</span><span class="p">]</span>
<span class="n">y0</span><span class="p">,</span> <span class="n">y0_err</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;y0_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;y0_sig&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameter mean values with uncertainties for a photopeak in a sample of Ba-133: </span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
      <span class="s1">&#39;            Amplitude = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_err</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;           Peak Energy = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> keV </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span> <span class="n">xc_err</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;    Standard Deviation = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> keV </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w_err</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;     Background Counts = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y0_err</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Parameter mean values with uncertainties for a photopeak in a sample of Ba-133:

            Amplitude = 789.3499838312316 ± 25.40762174271906 counts 
           Peak Energy = 160.60556153256505 ± 0.019374762693360942 keV 
    Standard Deviation = 0.5324207733753832 ± 0.017697951515753676 keV 
     Background Counts = 1334.1324943543657 ± 6.560639436166777 counts
</code></pre></div>

<h3 id="plotting-the-posterior">Plotting the posterior</h3>
<p>Using the mean values for each parameter, we can define a Gaussian curve for each peak. Plotting this curve over the original data gives the best fit curve for that data. This best fit can be integrated, and by summing the integrals for each peak, the total counts of the gamma-ray spectrum can be found.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># plot each peak, with the fitted Gaussians superimposed</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;a_mu&#39;</span><span class="p">]</span>
        <span class="n">xc</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;xc_mu&#39;</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;w_mu&#39;</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;y0_mu&#39;</span><span class="p">]</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">peaks_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">peaks_y</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># plot original data</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;b.&#39;</span><span class="p">,</span> 
                       <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                       <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Original Data&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="c1"># plot fitted curve over the data</span>
        <span class="n">xsmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="s1">&#39;k:&#39;</span><span class="p">,</span>
                       <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Fitted Model&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy / keV&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">leg</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lh</span> <span class="ow">in</span> <span class="n">leg</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span> 
    <span class="n">lh</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Photopeaks produced by a sample of Ba-133,&#39;</span> <span class="o">+</span>
             <span class="s1">&#39; with fitted Gaussian curves from MCMC sampling&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


<p><img alt="png" src="../output_40_0.png" /></p>
<p>Alternatively, instead of using the means of the parameters to plot the fitted curve, we can use the posterior distributions to randomly sample predictions of each parameter. We can then overplot multiple curves onto the data set. This is useful as instead of only showing the most likely model, it visualises the overall uncertainty of the fit.</p>
<p>Again, I'll use the noisiest peak as an example. First, randomly choose 300 of each parameter from their posteriors:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># number of curves to plot per peak</span>
<span class="n">n_fits</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">a_samps_pymc3</span><span class="p">,</span> <span class="n">xc_samps_pymc3</span><span class="p">,</span> <span class="n">w_samps_pymc3</span><span class="p">,</span> <span class="n">y0_samps_pymc3</span> <span class="o">=</span> <span class="p">([]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
    <span class="n">a_samps_pymc3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_fits</span><span class="p">))</span>
    <span class="n">xc_samps_pymc3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_fits</span><span class="p">))</span>
    <span class="n">w_samps_pymc3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_fits</span><span class="p">))</span>
    <span class="n">y0_samps_pymc3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="n">ind</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n_fits</span><span class="p">))</span>
</code></pre></div>


<p>We now have 300 sets of potential parammeters. For each set of parameters, define and overplot a Gaussian curve as before, each curve being slightly different. In regions of the plot where a lot of curves overlap, the plot will appear darker relative to regions with fewer curves. The resulting plots show the regions where a fitted curve is more likely to fall. This is called a posterior predictive plot.</p>
<p>The plot below shows the posterior predictive distribution for the noisiest photopeak. I also included a second plot, which shows a "zoomed in" view of the tip of the peak, at which the most deviation occurs.</p>
<div class="codehilite"><pre><span></span><code><span class="n">ind</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">peaks_x</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
<span class="n">xsmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fits</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">a_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">xc_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">w_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y0_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
             <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">a_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">xc_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">w_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">y0_samps_pymc3</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
             <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy / keV&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">159.4</span><span class="p">,</span><span class="mf">161.8</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1800</span><span class="p">,</span> <span class="mi">2250</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy / keV&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Posterior predictive plot for a photopeak from a sample of Ba-133&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


<p><img alt="png" src="../output_44_0.png" /></p>
<h3 id="model-comparisons">Model comparisons</h3>
<p>Now that we have a model with the mean fitted parameters for each curve, we can integrate to find the total area under a curve. Using the uncertainty in each parameter from above, the pecentage error in the total counts can be found. This can be used as a nice way to judge the quality of the fit, and whether the curve can be "trusted" to approximate the data. </p>
<p>Using scipy's "integrate.quad" function makes the integration simple. I'll use the same example peak as perviously, integrating between the bottom of the tails of the peak. When finding the area error, we must also consider the covariance between the amplitude and standard deviation, which I show below:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># parameter means and standard deviations of peak</span>
<span class="n">a_pymc3</span><span class="p">,</span> <span class="n">aerr_pymc3</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;a_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;a_sig&#39;</span><span class="p">]</span>
<span class="n">xc_pymc3</span><span class="p">,</span> <span class="n">xcerr_pymc3</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;xc_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;xc_sig&#39;</span><span class="p">]</span>
<span class="n">w_pymc3</span><span class="p">,</span> <span class="n">werr_pymc3</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;w_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;w_sig&#39;</span><span class="p">]</span>
<span class="n">y0_pymc3</span><span class="p">,</span> <span class="n">y0err_pymc3</span> <span class="o">=</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;y0_mu&#39;</span><span class="p">],</span> <span class="n">resdict</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;y0_sig&#39;</span><span class="p">]</span>
<span class="n">a_w_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">all_pymc3_samples</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<span class="c1"># integrate, dividing by the calibration coefficient (to remove keV from the units)</span>
<span class="n">peak_integral</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">gauss</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">a_pymc3</span><span class="p">,</span> <span class="n">xc_pymc3</span><span class="p">,</span>
                                               <span class="n">w_pymc3</span><span class="p">,</span> <span class="n">y0_pymc3</span><span class="p">),</span> <span class="mf">159.1</span><span class="p">,</span> <span class="mf">162.2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">c_0</span>
<span class="n">peak_integral_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">((</span><span class="n">w_pymc3</span> <span class="o">*</span> <span class="n">aerr_pymc3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                         <span class="p">(</span><span class="n">a_pymc3</span> <span class="o">*</span> <span class="n">werr_pymc3</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> 
                      <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">a_w_cov</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_0</span>

<span class="n">percent_err</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">peak_integral_err</span><span class="o">/</span><span class="n">peak_integral</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total counts = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak_integral</span><span class="p">,</span> <span class="n">peak_integral_err</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;Percentage error = </span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_err</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Total counts = 22933.86204613347 ± 195.58699451020811 counts 
Percentage error = 0.8500378971345341%
</code></pre></div>

<p>This percentage error was found using a Poisson likelihood, as described above. For a comparison, this integration can be repeated for the alternate sampling method, with a normal likelihood. Using the same alternate parameters that were found earlier, run the same integration process as before:</p>
<div class="codehilite"><pre><span></span><code><span class="n">peak_integral_alt</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> 
                                   <span class="n">gauss</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">a_alt</span><span class="p">,</span> <span class="n">xc_alt</span><span class="p">,</span> <span class="n">w_alt</span><span class="p">,</span> <span class="n">y0_alt</span><span class="p">),</span> <span class="mf">159.1</span><span class="p">,</span> <span class="mf">162.2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">c_0</span>
<span class="n">peak_integral_err_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> 
                                <span class="p">((</span><span class="n">w_alt</span> <span class="o">*</span> <span class="n">a_err_alt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> 
                <span class="p">(</span><span class="n">a_alt</span> <span class="o">*</span> <span class="n">w_err_alt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">a_alt</span><span class="o">*</span><span class="n">w_alt</span><span class="o">*</span><span class="n">a_w_alt_cov</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_0</span>

<span class="n">percent_err_alt</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">peak_integral_err_alt</span><span class="o">/</span><span class="n">peak_integral_alt</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alternate total counts = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak_integral_alt</span><span class="p">,</span>
                                                               <span class="n">peak_integral_err_alt</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;Alternate percentage error = </span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_err_alt</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Alternate total counts = 22943.751210742565 ± 193.76313608385547 counts 
Alternate percentage error = 0.8447589197287152%
</code></pre></div>

<p>It appears both methods result in a very simillar pecentage error, even though the alternate method is a little faster on my machine. This validates the theory that using a normal likelihood distribution on this photopeak approximates a Poisson distribution pretty well.</p>
<p>In both cases, a percentage error of around 1% is more than acceptable, in general. Initially, I used a least-squares algorithm to fit curves to this same data set, which produced a percentage error around 1.3%. This leads me to conclude that using an MCMC algorithm was quite successful.</p>
<h2 id="modelling-with-dynesty">Modelling with dynesty</h2>
<p>Now that we've evaluated PyMC3's abillity to sample the gamma-ray spectrum, we can explore other samplers to see if they produce simillar results. For this, I'll use "dynesty". This sampler uses nested sampling, rather than MCMC. The key difference between these algorithms is that nested sampling produces an estimate for the marginal likelihood, whilst MCMC does not. I'll again stick to using just the second peak, since we're only really interested in the relative performance of the samplers here.</p>
<h3 id="sampling-the-data_1">Sampling the data</h3>
<p>Using dynesty is slightly more complicated than PyMC3. Most nested sampling algorithms need to sample from a uniform hyper-cube parameter space. All of our priors have a normal prior distribution, so we first need to define a "prior transform" function. This function will transform the priors into the right format, and then transform them back after the sampling.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">priortransform</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>

    <span class="c1"># unpack the transformed parameters</span>
    <span class="n">a_t</span><span class="p">,</span> <span class="n">xc_t</span><span class="p">,</span> <span class="n">w_t</span><span class="p">,</span> <span class="n">y0_t</span> <span class="o">=</span> <span class="n">theta</span>  

    <span class="c1"># define our prior guesses for each parameter</span>
    <span class="n">a_mu</span><span class="p">,</span> <span class="n">a_sig</span> <span class="o">=</span> <span class="n">a_guesses</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">50.</span>
    <span class="n">xc_mu</span><span class="p">,</span> <span class="n">xc_sig</span> <span class="o">=</span> <span class="n">xc_guesses</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.</span>
    <span class="n">w_mu</span><span class="p">,</span> <span class="n">w_sig</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span>
    <span class="n">y0_mu</span><span class="p">,</span> <span class="n">y0_sig</span> <span class="o">=</span> <span class="n">y0_guesses</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">30.</span>

    <span class="c1"># convert back to </span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a_mu</span> <span class="o">+</span> <span class="n">a_sig</span><span class="o">*</span><span class="n">ndtri</span><span class="p">(</span><span class="n">a_t</span><span class="p">)</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">xc_mu</span> <span class="o">+</span> <span class="n">xc_sig</span><span class="o">*</span><span class="n">ndtri</span><span class="p">(</span><span class="n">xc_t</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w_mu</span> <span class="o">+</span> <span class="n">w_sig</span><span class="o">*</span><span class="n">ndtri</span><span class="p">(</span><span class="n">w_t</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">y0_mu</span> <span class="o">+</span> <span class="n">y0_sig</span><span class="o">*</span><span class="n">ndtri</span><span class="p">(</span><span class="n">y0_t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">,</span><span class="n">xc</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">y0</span>
</code></pre></div>


<p>Next, we need to define a Poisson log likelihood function. For dynesty, I'll be using a hand-made likelihood function:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to return the log likelihood</span>
<span class="sd">    :param theta: tuple or list containing each parameter</span>
<span class="sd">    :param obs: list or array containing the observed counts of each data point</span>
<span class="sd">    :param times: list or array containing the energy at which each data point is recorded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack parameters</span>
    <span class="n">a_like</span><span class="p">,</span> <span class="n">xc_like</span><span class="p">,</span> <span class="n">w_like</span><span class="p">,</span> <span class="n">y0_like</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="c1"># expected value</span>
    <span class="n">lmbda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gauss</span><span class="p">(</span><span class="n">peaks_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a_like</span><span class="p">,</span> <span class="n">xc_like</span><span class="p">,</span> <span class="n">w_like</span><span class="p">,</span> <span class="n">y0_like</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks_y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gammaln</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks_y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks_y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lmbda</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lmbda</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div>


<p>Now we can begin to set up the hyperparameters for the nested sampling algorithm. For dynesty, we need to provide the number of <a href="https://dynesty.readthedocs.io/en/latest/dynamic.html">live points</a>, sampling algorithm, sampling method, and a <a href="https://dynesty.readthedocs.io/en/latest/overview.html">stopping criterion</a>. Since the Gaussian model only has 4 parameters, we can choose a <a href="https://dynesty.readthedocs.io/en/latest/faq.html">bound and sampling method</a> that work well with low-dimensional models:</p>
<div class="codehilite"><pre><span></span><code><span class="n">stop</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># stopping criterion </span>
<span class="n">nparam</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># number of parameters</span>

<span class="n">sampler</span> <span class="o">=</span> <span class="n">NestedSampler</span><span class="p">(</span><span class="n">loglike</span><span class="p">,</span> <span class="n">priortransform</span><span class="p">,</span> <span class="n">nparam</span><span class="p">,</span>
                        <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="s1">&#39;unif&#39;</span><span class="p">,</span> <span class="n">nlive</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">t0_dynesty</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">sampler</span><span class="o">.</span><span class="n">run_nested</span><span class="p">(</span><span class="n">dlogz</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">print_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">t1_dynesty</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> seconds taken to run dynesty sampling&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1_dynesty</span><span class="o">-</span><span class="n">t0_dynesty</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>10.890472173690796 seconds taken to run dynesty sampling
</code></pre></div>

<p>We can now collect the results and view the summary of the sampling process, which includes the log of the marginal likelihood, number of interations, and some other values:</p>
<div class="codehilite"><pre><span></span><code><span class="n">results</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Summary
=======
nlive: 1000
niter: 13873
ncall: 86323
eff(%): 17.229
logz: -212.097 +/-  0.141
None
</code></pre></div>

<h3 id="results_1">Results</h3>
<p>To retrieve the posteriors for each parameter from a nested sampling algorithm, you need to resample using weights, which dynesty outputs with the results. This can be done easily as is shown below:</p>
<div class="codehilite"><pre><span></span><code><span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;logwt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;logz&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">samples</span>

<span class="n">dynesty_samples</span> <span class="o">=</span> <span class="n">resample_equal</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</code></pre></div>


<p>Now, using the same methods as before, we can print the mean and error of the parameters, and sample the posteriors to produce a posterior predictive plot for the second peak in our data:</p>
<div class="codehilite"><pre><span></span><code><span class="n">a</span><span class="p">,</span> <span class="n">xc</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="p">[</span><span class="n">dynesty_samples</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

<span class="n">a_dynesty</span><span class="p">,</span> <span class="n">aerr_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">xc_dynesty</span><span class="p">,</span> <span class="n">xcerr_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xc</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">xc</span><span class="p">)</span>
<span class="n">w_dynesty</span><span class="p">,</span> <span class="n">werr_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="n">y0_dynesty</span><span class="p">,</span> <span class="n">y0err_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
<span class="n">a_w_dynesty_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">dynesty_samples</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

<span class="n">nfits</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">a_samps_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">a_dynesty</span><span class="p">,</span> <span class="n">aerr_dynesty</span><span class="p">,</span> <span class="n">nfits</span><span class="p">)</span>
<span class="n">xc_samps_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">xc_dynesty</span><span class="p">,</span> <span class="n">xcerr_dynesty</span><span class="p">,</span> <span class="n">nfits</span><span class="p">)</span>
<span class="n">w_samps_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">w_dynesty</span><span class="p">,</span> <span class="n">werr_dynesty</span><span class="p">,</span> <span class="n">nfits</span><span class="p">)</span>
<span class="n">y0_samps_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">y0_dynesty</span><span class="p">,</span> <span class="n">y0err_dynesty</span><span class="p">,</span> <span class="n">nfits</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameter mean values with uncertainties for a photopeak in a sample of Ba-133: </span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;            Amplitude = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_dynesty</span><span class="p">,</span> <span class="n">aerr_dynesty</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;           Peak Energy = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> keV </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xc_dynesty</span><span class="p">,</span> <span class="n">xcerr_dynesty</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;    Standard Deviation = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> keV </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w_dynesty</span><span class="p">,</span> <span class="n">werr_dynesty</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;     Background Counts = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y0_dynesty</span><span class="p">,</span> <span class="n">y0err_dynesty</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Parameter mean values with uncertainties for a photopeak in a sample of Ba-133:

             Amplitude = 809.6473274589662 ± 24.636099224592314 counts 
           Peak Energy = 160.60478084398832 ± 0.019342705091128825 keV 
    Standard Deviation = 0.5237467836545735 ± 0.01933901750104941 keV 
     Background Counts = 1333.4565559019425 ± 6.802782860785766 counts
</code></pre></div>

<h3 id="plotting-the-posterior_1">Plotting the posterior</h3>
<p>So far, dynesty is in strong agreement with PyMC3, with both the values and errors being comparable to those from either PyMC3 sampling method we investigated. Below are two plots, the left plot shows the mean Gaussian curve produced by dynesty, and the right shows the posterior predictive plot:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">peaks_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">peaks_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">xsmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># mean posterior plot</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;b.&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span><span class="n">a_dynesty</span><span class="p">,</span><span class="n">xc_dynesty</span><span class="p">,</span><span class="n">w_dynesty</span><span class="p">,</span><span class="n">y0_dynesty</span><span class="p">),</span><span class="s1">&#39;k:&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">)</span>

<span class="c1"># posterior predictive plot</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfits</span><span class="p">):</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span><span class="n">a_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xc_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">w_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y0_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean posterior (left) and posterior predictive (right) of a photopeak in a sample of</span><span class="se">\n</span><span class="s1">&#39;</span>
           <span class="o">+</span> <span class="s1">&#39; Ba-133, sampled by dynesty&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


<p><img alt="png" src="../output_69_0.png" /></p>
<p>Again, this looks very simillar to the results produced by PyMC3. We can confirm this by remaking the same plot as above, but this time overplotting the mean and posterior predictive plots from PyMC3:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">peaks_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">peaks_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">xsmooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># mean posterior plot</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span><span class="n">a_dynesty</span><span class="p">,</span><span class="n">xc_dynesty</span><span class="p">,</span><span class="n">w_dynesty</span><span class="p">,</span><span class="n">y0_dynesty</span><span class="p">),</span><span class="s1">&#39;b:&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;dynesty&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span><span class="n">a_pymc3</span><span class="p">,</span><span class="n">xc_pymc3</span><span class="p">,</span><span class="n">w_pymc3</span><span class="p">,</span><span class="n">y0_pymc3</span><span class="p">),</span><span class="s1">&#39;r:&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;PyMC3&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">)</span>
<span class="n">leg1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lh</span> <span class="ow">in</span> <span class="n">leg1</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span> 
    <span class="n">lh</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># posterior predictive plot</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nfits</span><span class="p">):</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span><span class="n">a_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">xc_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">w_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">y0_samps_dynesty</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;dynesty&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span> <span class="n">gauss</span><span class="p">(</span><span class="n">xsmooth</span><span class="p">,</span><span class="n">a_samps_pymc3</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">xc_samps_pymc3</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">w_samps_pymc3</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">y0_samps_pymc3</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;PyMC3&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1200</span><span class="p">)</span>
<span class="n">leg2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lh</span> <span class="ow">in</span> <span class="n">leg2</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span> 
    <span class="n">lh</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mean posterior (left) and posterior predictive (right) plots of a photopeak in a sample&#39;</span>
             <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Ba-133, sampled by PyMC3 (red) and dynesty (blue)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>


<p><img alt="png" src="../output_71_0.png" /></p>
<h3 id="model-comparisons_1">Model comparisons</h3>
<p>This above plot shows quite nicely that whilst dynesty predicts a slightly higher amplitude than PyMC3, both samplers do agree with eachother to very simillar degrees of accuracy, with only a small discrepancy at the very tip of the peak. We can determine if this has a large impact on the results of the GRS analysis by finding the area under the mean curve produced by dynesty:</p>
<div class="codehilite"><pre><span></span><code><span class="n">peak_integral_dynesty</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> 
                                       <span class="n">gauss</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">a_dynesty</span><span class="p">,</span> <span class="n">xc_dynesty</span><span class="p">,</span>
                                             <span class="n">w_dynesty</span><span class="p">,</span> <span class="n">y0_dynesty</span><span class="p">),</span> <span class="mf">159.1</span><span class="p">,</span> <span class="mf">162.2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">c_0</span>
<span class="n">peak_integral_err_dynesty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> 
                                    <span class="p">((</span><span class="n">w_dynesty</span> <span class="o">*</span> <span class="n">aerr_dynesty</span><span class="p">)</span><span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                     <span class="p">(</span><span class="n">a_dynesty</span> <span class="o">*</span> <span class="n">werr_dynesty</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span>
                            <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">a_dynesty</span><span class="o">*</span><span class="n">w_dynesty</span><span class="o">+</span><span class="n">a_w_dynesty_cov</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_0</span>

<span class="n">percent_err_dynesty</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">peak_integral_err_dynesty</span><span class="o">/</span><span class="n">peak_integral_dynesty</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total counts = </span><span class="si">{}</span><span class="s1"> </span><span class="se">\u00B1</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> counts </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak_integral_dynesty</span><span class="p">,</span>
                                                               <span class="n">peak_integral_err_dynesty</span><span class="p">)</span> <span class="o">+</span>
      <span class="s1">&#39;Percentage error = </span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent_err_dynesty</span><span class="p">))</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>Total counts = 22968.854117562147 ± 201.03466521968398 counts 
Percentage error = 0.8793029468008915%
</code></pre></div>

<p>Within their errors, dynesty and both PyMC3 methods agree on the total counts under the curve, and have produce a percentage error under 1%. </p>
<p>PyMC3 is a little more intuative to use in general, however dynesty is a lot faster than PyMC3 on my machine, and also gives a value for the marginal likelihood in the process.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../.." title="Introduction" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Introduction
              </div>
            </div>
          </a>
        
        
          <a href="../../LightCurve/LightCurve/" title="Exoplanet Light Curve Analysis with emcee and UltraNest" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Exoplanet Light Curve Analysis with emcee and UltraNest
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.92ffa368.min.js"></script>
      <script src="../../assets/javascripts/bundle.5123e3d4.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
      
    
  </body>
</html>